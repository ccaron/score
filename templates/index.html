<!DOCTYPE html>
<html>
<head>
    <title>Game Score</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <style>
        .remove-penalty { margin-left: 10px; cursor: pointer; color: #f00; font-weight: bold; }
        .event-log-item { margin-bottom: 5px; }
        .score-display { font-size: 2.5em; font-weight: bold; }
        .penalty-list-item { display: flex; justify-content: space-between; align-items: center; }

        /* Custom styles for the new layout */
        .main-score-area {
            display: flex;
            justify-content: space-around;
            align-items: flex-start; /* Align items to the top to accommodate penalty lists */
            margin-bottom: 20px;
        }

        .score-box {
            text-align: center;
            flex-grow: 1;
            display: flex; /* Use flex for internal layout */
            flex-direction: column;
            align-items: center;
        }

        .center-display {
            text-align: center;
            flex-grow: 0;
            margin: 0 20px;
        }

        .clock-time {
            font-size: 4em;
            font-weight: bold;
            line-height: 1;
        }

        .period-display {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 15px; /* Add some space below period */
        }
        
        .penalty-section {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <div id="game-over-message" class="notification is-danger is-hidden has-text-centered mb-5">
                <p class="title is-4">Game Over!</p>
            </div>

            <div class="main-score-area">
                <div class="score-box">
                    <p class="heading">Home</p>
                    <p class="title has-text-home score-display" id="home_score">{{ engine.home_score }}</p>
                    <div class="penalty-section">
                        <p class="subtitle is-6">Home Penalties</p>
                        <div class="box p-3">
                            <ul id="home-penalties-list">
                                {% for penalty in engine.penalties if penalty.team == 'home' %}
                                <li class="penalty-list-item">{{ penalty.player }} - {{ "{:02d}:{:02d}".format(penalty.remaining // 60, penalty.remaining % 60) }}<span class="remove-penalty" onclick="removePenalty({{ penalty.id }})">x</span></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="center-display">
                    <p class="clock-time" id="clock">{{ "{:02d}:{:02d}".format(engine.time // 60, engine.time % 60) }}</p>
                    <p class="period-display" id="period">Period {{ engine.period }}</p>
                    <button class="button is-large is-primary mt-3" id="start-stop-button" onclick="toggleClock()">
                        {{ "Stop Clock" if engine.clock_running else "Start Clock" }}
                    </button>
                </div>

                <div class="score-box">
                    <p class="heading">Away</p>
                    <p class="title has-text-away score-display" id="away_score">{{ engine.away_score }}</p>
                    <div class="penalty-section">
                        <p class="subtitle is-6">Away Penalties</p>
                        <div class="box p-3">
                            <ul id="away-penalties-list">
                                {% for penalty in engine.penalties if penalty.team == 'away' %}
                                <li class="penalty-list-item">{{ penalty.player }} - {{ "{:02d}:{:02d}".format(penalty.remaining // 60, penalty.remaining % 60) }}<span class="remove-penalty" onclick="removePenalty({{ penalty.id }})">x</span></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <div class="columns">
                <div class="column is-half">
                    <h2 class="subtitle">Record Goal</h2>
                    <form class="box" id="record-goal-form">
                        <div class="field">
                            <label class="label">Scoring Player</label>
                            <div class="control">
                                <input class="input" type="text" id="goal-player" required>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Assist 1 (Optional)</label>
                            <div class="control">
                                <input class="input" type="text" id="goal-assist1">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Assist 2 (Optional)</label>
                            <div class="control">
                                <input class="input" type="text" id="goal-assist2">
                            </div>
                        </div>
                        <div class="field is-grouped">
                            <p class="control">
                                <button class="button is-success" type="button" onclick="recordGoal('home')">Home Goal</button>
                            </p>
                            <p class="control">
                                <button class="button is-info" type="button" onclick="recordGoal('away')">Away Goal</button>
                            </p>
                        </div>
                    </form>

                    <h2 class="subtitle mt-5">Home Goal Log</h2>
                    <div class="box">
                        <ul id="home-goal-log-list">
                        </ul>
                    </div>

                    <h2 class="subtitle mt-5">Away Goal Log</h2>
                    <div class="box">
                        <ul id="away-goal-log-list">
                        </ul>
                    </div>
                </div>

                <div class="column is-half">
                    <h2 class="subtitle">Add Penalty</h2>
                    <form class="box" onsubmit="addPenalty(event)">
                        <div class="field">
                            <label class="label">Player</label>
                            <div class="control">
                                <input class="input" type="text" id="penalty-player" placeholder="Player Name" required>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Duration (MM:SS)</label>
                            <div class="control">
                                <input class="input" type="text" id="penalty-duration" placeholder="MM:SS" required pattern="[0-5]?\d:[0-5]\d">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Team</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="penalty-team" required>
                                        <option value="home">Home</option>
                                        <option value="away">Away</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <button class="button is-link" type="submit">Add Penalty</button>
                            </div>
                        </div>
                    </form>

                    <h2 class="subtitle mt-5">Home Penalty Log</h2>
                    <div class="box">
                        <ul id="home-penalty-log-list">
                        </ul>
                    </div>
                    <h2 class="subtitle mt-5">Away Penalty Log</h2>
                    <div class="box">
                        <ul id="away-penalty-log-list">
                        </ul>
                    </div>
                </div>
            </div>
            
            <hr>
            <div class="has-text-centered">
                <button class="button is-warning is-large" onclick="resetGame()">Reset Game</button>
            </div>
        </div>
    </section>

    <script>
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function updateClock() {
            const response = await fetch('/time');
            const data = await response.json();
            document.getElementById('clock').textContent = formatTime(data.time);
            
            const startStopButton = document.getElementById('start-stop-button');
            if (data.running) {
                startStopButton.textContent = 'Stop Clock';
                startStopButton.classList.remove('is-primary');
                startStopButton.classList.add('is-danger');
            } else {
                startStopButton.textContent = 'Start Clock';
                startStopButton.classList.remove('is-danger');
                startStopButton.classList.add('is-primary');
            }
        }

        async function toggleClock() {
            const response = await fetch('/time');
            const data = await response.json();
            if (data.running) {
                await fetch('/stop', { method: 'POST' });
            } else {
                await fetch('/start', { method: 'POST' });
            }
        }

        async function updateHomePenalties() {
            const response = await fetch('/home_penalties');
            const data = await response.json();
            const penaltiesList = document.getElementById('home-penalties-list');
            penaltiesList.innerHTML = '';
            data.penalties.forEach(penalty => {
                const li = document.createElement('li');
                li.className = 'penalty-list-item';
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove-penalty';
                removeSpan.textContent = 'x';
                removeSpan.onclick = () => removePenalty(penalty.id);
                
                li.innerHTML = `<span>${penalty.player} - ${penalty.remaining_formatted}</span>`;
                li.appendChild(removeSpan);
                
                penaltiesList.appendChild(li);
            });
        }

        async function updateAwayPenalties() {
            const response = await fetch('/away_penalties');
            const data = await response.json();
            const penaltiesList = document.getElementById('away-penalties-list');
            penaltiesList.innerHTML = '';
            data.penalties.forEach(penalty => {
                const li = document.createElement('li');
                li.className = 'penalty-list-item';
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove-penalty';
                removeSpan.textContent = 'x';
                removeSpan.onclick = () => removePenalty(penalty.id);
                
                li.innerHTML = `<span>${penalty.player} - ${penalty.remaining_formatted}</span>`;
                li.appendChild(removeSpan);
                
                penaltiesList.appendChild(li);
            });
        }
        
        async function updateScores() {
            const response = await fetch('/scores');
            const data = await response.json();
            document.getElementById('home_score').textContent = data.home_score;
            document.getElementById('away_score').textContent = data.away_score;
        }

        async function updateGameStatus() {
            const response = await fetch('/game_status');
            const data = await response.json();
            document.getElementById('period').textContent = `Period ${data.period}`;
            const gameOverMessage = document.getElementById('game-over-message');
            if (data.game_over) {
                gameOverMessage.classList.remove('is-hidden');
            } else {
                gameOverMessage.classList.add('is-hidden');
            }
        }

        async function updateHomeGoalLog() {
            const response = await fetch('/home_goal_log');
            const data = await response.json();
            const goalLogList = document.getElementById('home-goal-log-list');
            goalLogList.innerHTML = '';
            data.home_goal_log.forEach(goalMessage => {
                const li = document.createElement('li');
                li.className = 'event-log-item';
                li.textContent = goalMessage;
                goalLogList.prepend(li);
            });
        }

        async function updateAwayGoalLog() {
            const response = await fetch('/away_goal_log');
            const data = await response.json();
            const goalLogList = document.getElementById('away-goal-log-list');
            goalLogList.innerHTML = '';
            data.away_goal_log.forEach(goalMessage => {
                const li = document.createElement('li');
                li.className = 'event-log-item';
                li.textContent = goalMessage;
                goalLogList.prepend(li);
            });
        }

        async function updateHomePenaltyLog() {
            const response = await fetch('/home_penalty_log');
            const data = await response.json();
            const penaltyLogList = document.getElementById('home-penalty-log-list');
            penaltyLogList.innerHTML = '';
            data.home_penalty_log.forEach(penaltyMessage => {
                const li = document.createElement('li');
                li.className = 'event-log-item';
                li.textContent = penaltyMessage;
                penaltyLogList.prepend(li);
            });
        }

        async function updateAwayPenaltyLog() {
            const response = await fetch('/away_penalty_log');
            const data = await response.json();
            const penaltyLogList = document.getElementById('away-penalty-log-list');
            penaltyLogList.innerHTML = '';
            data.away_penalty_log.forEach(penaltyMessage => {
                const li = document.createElement('li');
                li.className = 'event-log-item';
                li.textContent = penaltyMessage;
                penaltyLogList.prepend(li);
            });
        }


        setInterval(updateClock, 1000);
        setInterval(updateHomePenalties, 1000);
        setInterval(updateAwayPenalties, 1000);
        setInterval(updateScores, 1000);
        setInterval(updateGameStatus, 1000);
        setInterval(updateHomeGoalLog, 1000);
        setInterval(updateAwayGoalLog, 1000);
        setInterval(updateHomePenaltyLog, 1000);
        setInterval(updateAwayPenaltyLog, 1000);


        async function resetGame() {
            await fetch('/reset', { method: 'POST' });
            location.reload();
        }

        async function recordGoal(team) {
            const player = document.getElementById('goal-player').value;
            const assist1 = document.getElementById('goal-assist1').value;
            const assist2 = document.getElementById('goal-assist2').value;

            const formData = new FormData();
            formData.append('team', team);
            formData.append('player', player);
            if (assist1) formData.append('assist1', assist1);
            if (assist2) formData.append('assist2', assist2);

            await fetch('/goal', { method: 'POST', body: formData });

            // Clear form fields
            document.getElementById('goal-player').value = '';
            document.getElementById('goal-assist1').value = '';
            document.getElementById('goal-assist2').value = '';
        }

        async function addPenalty(event) {
            event.preventDefault();
            const player = document.getElementById('penalty-player').value;
            const duration = document.getElementById('penalty-duration').value;
            const team = document.getElementById('penalty-team').value;
            const formData = new FormData();
            formData.append('player', player);
            formData.append('duration', duration);
            formData.append('team', team);
            await fetch('/penalty', { method: 'POST', body: formData });
        }
        
        async function removePenalty(penaltyId) {
            await fetch(`/penalty/${penaltyId}`, { method: 'DELETE' });
            // Refresh both penalty lists after removal
            await updateHomePenalties();
            await updateAwayPenalties();
        }
    </script>
</body>
</html>
